#!/usr/bin/env python

import os
import sys
import argh
import requests

from os import path


def get_formulas():
    data = requests.get("https://api.github.com/users/saltstack-formulas/repos").json()
    formulas = filter(lambda x: x["name"].endswith("-formula"), data)
    return sorted(formulas, key=lambda x: x["name"])


def curdir_parent_path():
    return path.split(path.realpath(path.curdir))[0]


def curdir_name():
    return path.split(path.realpath(path.curdir))[1]

def formulas_location():
    if curdir_name() == "salt":
        return path.join(curdir_parent_path(), "formulas")

    return path.join(path.realpath(path.curdir), "formulas")


def list():
    for i in get_formulas():
        print i["name"].replace("-formula", ""),
        if i["description"] and i["description"].strip():
            print "-", i["description"]
        else:
            print


def install(name):
    formulas = get_formulas()
    name = name.replace("-formula", "")
    if name not in [x["name"].replace("-formula", "") for x in formulas]:
        sys.stderr.write("Uknow formula: %s\n" % name)
        sys.exit(1)

    if not path.exists(formulas_location()):
        os.makedirs(formulas_location())


parser = argh.ArghParser()
parser.add_commands([list, install])


if __name__ == '__main__':
    parser.dispatch()
